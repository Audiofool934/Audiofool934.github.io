---
import { getCollection } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import BlogPost from "../../components/BlogPost.astro";

export async function getStaticPaths() {
	const projects = await getCollection("projects");
	const notes = await getCollection("notes");
	const audioshow = await getCollection("audioshow");

	const allPosts = [...projects, ...notes, ...audioshow];
	const tagMap = new Map();

	allPosts.forEach((post) => {
		(post.data.tags ?? []).forEach((tag) => {
			if (!tagMap.has(tag)) tagMap.set(tag, []);
			tagMap.get(tag).push(post);
		});
	});

	return [...tagMap.entries()].map(([tag, entries]) => ({
		params: { tag },
		props: { posts: entries },
	}));
}

const { tag } = Astro.params;
const { posts } = Astro.props;
const sortedPosts = posts.sort(
	(a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
);
---

<BaseLayout
	pageTitle={`#${tag}`}
	headTitle={`Tag: ${tag}`}
	lede={`Every post that mentions ${tag}.`}
>
	<section>
		<ul class="list-reset grid-auto">
			{
				sortedPosts.map((post) => {
					const collection = post.collection;
					const url = `/${collection === "notes" ? "notes" : collection}/${post.slug}/`;
					return (
						<BlogPost
							url={url}
							title={post.data.title}
							description={post.data.description}
							meta={post.data.pubDate.toLocaleDateString("en", {
								month: "short",
								day: "numeric",
								year: "numeric",
							})}
							tags={post.data.tags}
						/>
					);
				})
			}
		</ul>
	</section>
</BaseLayout>
