---
import { getCollection } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import BlogPost from "../components/BlogPost.astro";

const allPosts = await getCollection("notes");
const posts = allPosts.sort(
	(a, b) => b.data.pubDate.getTime() - a.data.pubDate.getTime(),
);
const headTitle = "Notes";
const pageTitle = "Notes";
const lede =
	"Study notes that track probability, information theory, ML, and everything adjacent.";

const tagCounts = posts
	.map((post) => post.data.tags ?? [])
	.flat()
	.reduce((acc, tag) => {
		acc[tag] = (acc[tag] ?? 0) + 1;
		return acc;
	}, {});
const tags = (Object.entries(tagCounts) as [string, number][]).sort(
	(a, b) => b[1] - a[1],
);

const collections = [
	{
		title: "Probability I · II · III",
		description:
			"A rolling series of measure, convergence, and stochastic process notes.",
		status: "upcoming",
	},
	{
		title: "Information Theory Pack",
		description:
			"From Shannon to modern cross-entropy recipes, tidied into one thread.",
		status: "drafting",
	},
];

const formatDate = (value) =>
	new Date(value).toLocaleDateString("en", {
		month: "long",
		day: "numeric",
		year: "numeric",
	});
---

<BaseLayout pageTitle={pageTitle} headTitle={headTitle} lede={lede}>
	<section>
		<p class="eyebrow">Browse by tag</p>
		<div class="tag-search">
			{
				tags.map(([tag, count]) => (
					<a href={`/tags/${tag}`} class="surface-card">
						<span>{tag}</span>
						<span class="muted">{count} entries</span>
					</a>
				))
			}
		</div>
	</section>

	<section>
		<p class="eyebrow">Latest notes</p>
		<p class="muted">
			New entries land here first. Everything is reverse-chronological.
		</p>
		<ul class="list-reset column-list">
			{
				posts.map((post) => (
					<BlogPost
						url={`/notes/${post.slug}/`}
						title={post.data.title}
						description={post.data.description}
						meta={formatDate(post.data.pubDate)}
						tags={post.data.tags}
					/>
				))
			}
		</ul>
	</section>

	<section>
		<p class="eyebrow">Collections (in progress)</p>
		<div class="collections">
			{
				collections.map((collection) => (
					<div class="surface-card">
						<p class="pill">{collection.status}</p>
						<h3>{collection.title}</h3>
						<p>{collection.description}</p>
					</div>
				))
			}
		</div>
	</section>
</BaseLayout>

<style>
	.tag-search {
		display: grid;
		gap: 0.6rem;
		grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
	}

	.tag-search a {
		text-decoration: none;
		display: flex;
		flex-direction: column;
		gap: 0.2rem;
	}

	.column-list li + li {
		margin-top: 0.6rem;
	}

	.collections {
		display: grid;
		gap: 1rem;
		grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
	}
</style>
