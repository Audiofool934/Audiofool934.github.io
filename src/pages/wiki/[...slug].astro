---
import { getCollection } from "astro:content";
import MinimalLayout from "../../layouts/MinimalLayout.astro";
import "../../style/post.css";

export async function getStaticPaths() {
    const wikiEntries = await getCollection("wiki");
    return wikiEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
---

<MinimalLayout
    title={`${entry.data.title} | Wiki`}
    description="Knowledge Graph"
>
    <!-- Breadcrumb / Back Navigation -->
    <div
        class="border-b border-[var(--border-main)] bg-[var(--bg-body)] sticky top-0 z-10"
    >
        <div
            class="max-w-4xl mx-auto px-6 md:px-12 py-3 font-mono text-xs text-[var(--text-muted)] flex items-center gap-2"
        >
            <a
                href="/wiki/"
                class="hover:text-[var(--text-main)] transition-colors">Wiki</a
            >
            <span>/</span>
            <span class="text-[var(--text-main)] truncate"
                >{entry.data.title}</span
            >
        </div>
    </div>

    <!-- Main Content -->
    <article
        class="p-6 md:p-12 max-w-4xl mx-auto min-h-screen"
        transition:animate="fade"
    >
        <header class="mb-12 border-b border-[var(--border-main)] pb-6">
            <h1 class="text-3xl md:text-4xl font-bold font-heading mb-4">
                {entry.data.title}
            </h1>

            <div class="flex flex-wrap gap-3 items-center justify-between">
                <div class="flex gap-2">
                    {
                        entry.data.tags.map((tag) => (
                            <a
                                href={`/wiki/#${tag.toLowerCase()}`}
                                class="text-xs font-mono text-[var(--text-muted)] hover:text-[var(--text-main)] hover:underline px-1 border border-[var(--border-subtle)] rounded transition-colors"
                            >
                                #{tag}
                            </a>
                        ))
                    }
                </div>

                {
                    entry.data.updatedDate && (
                        <div class="font-mono text-xs text-[var(--text-muted)]">
                            Last Updated:{" "}
                            {entry.data.updatedDate.toISOString().split("T")[0]}
                        </div>
                    )
                }
            </div>
        </header>

        <div
            class="post-content prose prose-invert max-w-none prose-headings:font-heading prose-a:text-[var(--text-main)] prose-code:font-mono"
        >
            <Content />
        </div>

        <!-- Graph Connections -->
        {
            (entry.data.parents?.length || entry.data.related?.length) && (
                <div class="mt-20 pt-8 border-t border-[var(--border-main)]">
                    <h3 class="font-mono text-xs uppercase mb-6 text-[var(--text-muted)] tracking-wider">
                        Connected Nodes
                    </h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        {entry.data.parents &&
                            entry.data.parents.length > 0 && (
                                <div>
                                    <span class="block text-xs text-[var(--text-muted)] mb-3 opacity-60">
                                        Parents
                                    </span>
                                    <div class="flex flex-col gap-2">
                                        {entry.data.parents.map((p) => (
                                            <div class="text-sm font-mono border-l-2 border-[var(--border-main)] pl-3">
                                                {p}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}

                        {entry.data.related &&
                            entry.data.related.length > 0 && (
                                <div>
                                    <span class="block text-xs text-[var(--text-muted)] mb-3 opacity-60">
                                        Related
                                    </span>
                                    <div class="flex flex-col gap-2">
                                        {entry.data.related.map((r) => (
                                            <div class="text-sm font-mono border-l-2 border-[var(--border-main)] pl-3">
                                                {r}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                    </div>
                </div>
            )
        }
    </article>
</MinimalLayout>
