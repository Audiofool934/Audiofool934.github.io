---
import { getCollection } from "astro:content";
import MinimalLayout from "../../layouts/MinimalLayout.astro";
import "../../style/post.css";

export async function getStaticPaths() {
    const wikiEntries = await getCollection("wiki");
    return wikiEntries.map((entry) => ({
        params: { slug: entry.slug },
        props: { entry },
    }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();

// Helper to get breadcrumbs from slug
const breadcrumbs = entry.slug.split("/");
const wikiEntries = await getCollection("wiki"); // Re-fetching for Sidebar context
---

<MinimalLayout
    title={`${entry.data.title} | Wiki`}
    description="Knowledge Graph"
>
    <div class="flex flex-col md:flex-row h-full">
        <!-- Sidebar / Tree (Identical to Index for persistence illusion) -->
        <div
            class="hidden md:block w-72 border-r border-[var(--border-main)] p-6 overflow-y-auto h-screen bg-[var(--bg-body)] flex-shrink-0 sticky top-0"
        >
            <div class="mb-6">
                <a href="/wiki/" class="font-bold text-xl mb-1 hover:underline"
                    >Wiki</a
                >
                <p class="text-xs font-mono text-[var(--text-muted)] uppercase">
                    Index / Graph
                </p>
            </div>

            <!-- Search Box -->
            <div class="mb-6">
                <input
                    type="text"
                    placeholder="Cmd+K to search..."
                    class="w-full bg-transparent border border-[var(--border-main)] px-3 py-2 text-sm font-mono focus:outline-none focus:bg-[var(--text-main)] focus:text-[var(--bg-body)] transition-colors"
                />
            </div>

            <!-- Simple List (Active State Highlight) -->
            <nav class="space-y-1">
                {
                    wikiEntries.map((e) => (
                        <a
                            href={`/wiki/${e.slug}/`}
                            class={`block py-1 text-sm transition-all ${e.slug === entry.slug ? "text-[var(--text-main)] font-bold pl-2 border-l-2 border-[var(--text-main)]" : "text-[var(--text-muted)] hover:text-[var(--text-main)] hover:pl-2"}`}
                        >
                            {e.data.title}
                        </a>
                    ))
                }
            </nav>
        </div>

        <!-- Content Pane -->
        <div class="flex-1 min-w-0">
            <!-- Mobile Header (Breadcrumbs) -->
            <div
                class="p-4 border-b border-[var(--border-main)] font-mono text-xs text-[var(--text-muted)] overflow-x-auto whitespace-nowrap"
            >
                <a href="/wiki/">Wiki</a>
                {breadcrumbs.map((part, index) => <span> / {part}</span>)}
            </div>

            <article class="p-8 md:p-12 max-w-4xl mx-auto">
                <header class="mb-8 border-b border-[var(--border-main)] pb-4">
                    <h1 class="text-3xl font-bold font-heading mb-4">
                        {entry.data.title}
                    </h1>
                    <div class="flex gap-2">
                        {
                            entry.data.tags.map((tag) => (
                                <span class="text-xs font-mono text-[var(--text-muted)] px-1 border border-[var(--border-subtle)] rounded">
                                    {tag}
                                </span>
                            ))
                        }
                    </div>
                </header>

                <div class="post-content">
                    <Content />
                </div>

                <!-- Graph Connections (Mock) -->
                {
                    (entry.data.parents || entry.data.related) && (
                        <div class="mt-16 pt-8 border-t border-[var(--border-main)]">
                            <h3 class="font-mono text-xs uppercase mb-4 text-[var(--text-muted)]">
                                Connected Nodes
                            </h3>
                            <div class="flex flex-wrap gap-4">
                                {entry.data.parents?.map((p) => (
                                    <span class="text-sm border-b border-dotted border-[var(--text-muted)]">
                                        ↑ {p}
                                    </span>
                                ))}
                                {entry.data.related?.map((r) => (
                                    <span class="text-sm border-b border-dotted border-[var(--text-muted)]">
                                        ↔ {r}
                                    </span>
                                ))}
                            </div>
                        </div>
                    )
                }
            </article>
        </div>
    </div>
</MinimalLayout>
