---
// AudioPlayer Component - Persistent music player with state management
// State persists across View Transitions via window.__audioPlayerState
---

<div
    id="audio-player-bar"
    class="flex flex-col gap-4 w-full bg-[var(--bg-body)] z-[100] transition-all duration-300 mt-auto"
    transition:persist
>
    <!-- Hidden Audio Element -->
    <audio id="main-audio-element" preload="auto"></audio>

    <!-- Header -->
    <div class="flex items-center justify-between">
        <span
            class="text-[10px] font-mono uppercase tracking-widest text-[var(--text-muted)]"
            >Now Playing</span
        >
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse">
            </div>
            <span class="text-[10px] font-mono text-[var(--text-muted)]"
                >Online</span
            >
        </div>
    </div>

    <!-- Art -->
    <div
        id="player-art"
        class="w-full aspect-square bg-[var(--bg-body)] border border-[var(--border-main)] relative overflow-hidden group"
    >
        <img
            id="player-art-img"
            src=""
            class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500"
        />
        <div
            id="player-art-placeholder"
            class="absolute inset-0 flex items-center justify-center font-mono text-2xl text-[var(--text-muted)]"
        >
            üìª
        </div>

        <!-- Hover Overlay for Play Toggle -->
        <div
            class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer"
            onclick="document.getElementById('player-play-btn').click()"
        >
            <span class="text-white text-3xl opacity-80 hover:opacity-100"
                >‚èØ</span
            >
        </div>
    </div>

    <!-- Track Info -->
    <div class="flex flex-col min-w-0">
        <div
            id="player-track-name"
            class="text-sm font-bold truncate leading-tight"
        >
            Select a track...
        </div>
        <div
            id="player-artist-name"
            class="text-xs text-[var(--text-muted)] truncate mt-1"
        >
            AudioShow
        </div>
    </div>

    <!-- Controls & Progress -->
    <div class="flex flex-col gap-3 w-full">
        <!-- Progress Bar -->
        <div
            class="w-full h-1 bg-[var(--text-muted)]/30 relative group cursor-pointer"
            id="player-seek-container"
        >
            <div
                id="player-progress-bar"
                class="absolute top-0 left-0 h-full bg-[var(--text-main)] w-0"
            >
            </div>
            <!-- Hit Area -->
            <div
                class="absolute -top-2 -bottom-2 left-0 right-0 bg-transparent"
            >
            </div>
        </div>

        <!-- Time & Controls -->
        <div
            class="flex items-center justify-between text-[10px] font-mono text-[var(--text-muted)]"
        >
            <span id="player-current-time">0:00</span>
            <button
                id="player-play-btn"
                class="hover:text-[var(--text-main)] transition-colors disabled:opacity-30 p-1"
                disabled
            >
                <span id="play-icon" class="text-xl">‚ñ∂</span>
            </button>
            <span id="player-duration">0:00</span>
        </div>
    </div>
</div>

<script is:inline>
    // Audio Player State Management - Single Source of Truth Pattern
    (function () {
        // ========================================
        // STATE: Lives on window, survives View Transitions
        // ========================================
        // window.__audioPlayerState = {
        //     initialized: false,     // Has setup() run?
        //     track: null,            // { title, artist, artwork, url }
        //     isPlaying: false
        // };

        // ========================================
        // DOM REFERENCES (resolved fresh each time)
        // ========================================
        function getElements() {
            return {
                audio: document.getElementById("main-audio-element"),
                playBtn: document.getElementById("player-play-btn"),
                playIcon: document.getElementById("play-icon"),
                seekContainer: document.getElementById("player-seek-container"),
                progressBar: document.getElementById("player-progress-bar"),
                currTimeEl: document.getElementById("player-current-time"),
                durationEl: document.getElementById("player-duration"),
                trackNameEl: document.getElementById("player-track-name"),
                artistNameEl: document.getElementById("player-artist-name"),
                artImg: document.getElementById("player-art-img"),
                artPlaceholder: document.getElementById(
                    "player-art-placeholder",
                ),
            };
        }

        // ========================================
        // UI SYNC: One-way state ‚Üí DOM
        // ========================================
        function syncUIWithState() {
            const state = window.__audioPlayerState;
            const els = getElements();
            if (!els.audio || !els.playBtn) return;

            const track = state?.track;
            if (track) {
                els.trackNameEl.textContent = track.title || "Unknown";
                els.artistNameEl.textContent = track.artist || "AudioShow";
                if (track.artwork) {
                    els.artImg.src = track.artwork;
                    els.artImg.style.opacity = "1";
                    els.artPlaceholder.style.opacity = "0";
                }
            }

            els.playIcon.textContent = state?.isPlaying ? "II" : "‚ñ∂";
            els.playBtn.disabled = false;
        }

        // ========================================
        // PROVIDERS: Type-specific metadata resolution
        // ========================================
        const providers = {
            apple: {
                name: "Apple Music",
                async resolve(track) {
                    let trackId = track.id;
                    if (!trackId && track.url) {
                        const match = track.url.match(/[?&]i=(\d+)/);
                        trackId = match ? match[1] : null;
                    }
                    if (!trackId) throw new Error("Invalid Apple Music ID");

                    const resp = await fetch(
                        `https://itunes.apple.com/lookup?id=${trackId}&country=cn`,
                    );
                    const data = await resp.json();
                    if (data.resultCount > 0) {
                        const info = data.results[0];
                        return {
                            url: info.previewUrl,
                            title: info.trackName,
                            artist: info.artistName,
                            // Use provided artwork, fallback to API artwork
                            artwork:
                                track.artwork ||
                                info.artworkUrl100?.replace(
                                    "100x100",
                                    "300x300",
                                ),
                        };
                    }
                    throw new Error("Track not found");
                },
            },
            local: {
                name: "Local Audio",
                async resolve(track) {
                    return {
                        url: track.url,
                        title: track.title || "Unknown Track",
                        artist: track.artist || "AudioShow",
                        artwork: track.artwork,
                    };
                },
            },
        };

        // ========================================
        // INIT: Called on every page-load
        // ========================================
        function initPlayer() {
            // Ensure state object exists
            if (!window.__audioPlayerState) {
                window.__audioPlayerState = {
                    initialized: false,
                    track: null,
                    isPlaying: false,
                    currentTime: 0, // Store playback position
                };
            }

            const state = window.__audioPlayerState;
            const els = getElements();
            if (!els.audio || !els.playBtn) return;

            // First time: load default track
            if (!state.initialized) {
                state.initialized = true;
                if (!state.track && window.__defaultAudioShowTrack) {
                    state.track = {
                        title: window.__defaultAudioShowTrack.title,
                        artist: window.__defaultAudioShowTrack.artist,
                        artwork: window.__defaultAudioShowTrack.artwork,
                        url: window.__defaultAudioShowTrack.url,
                        type: window.__defaultAudioShowTrack.type,
                    };
                }
            }

            // ALWAYS re-attach event handlers (DOM may have been recreated)
            function formatTime(seconds) {
                if (!seconds || isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, "0")}`;
            }

            // Play Button
            els.playBtn.onclick = async () => {
                const audio = els.audio;
                const noSource =
                    !audio.src ||
                    audio.src === "" ||
                    audio.src === window.location.href;

                if (noSource && state.track && state.track.url) {
                    audio.src = state.track.url;
                    // Restore playback position if we had one
                    if (state.currentTime > 0) {
                        audio.currentTime = state.currentTime;
                    }
                }

                if (audio.paused) {
                    try {
                        await audio.play();
                    } catch (e) {
                        console.error("Playback failed:", e);
                    }
                } else {
                    audio.pause();
                }
            };

            // Audio Events
            els.audio.onplay = () => {
                state.isPlaying = true;
                syncUIWithState();
            };
            els.audio.onpause = () => {
                state.isPlaying = false;
                syncUIWithState();
            };
            els.audio.ontimeupdate = () => {
                state.currentTime = els.audio.currentTime; // Save position
                const percent =
                    (els.audio.currentTime / els.audio.duration) * 100;
                els.progressBar.style.width = `${percent}%`;
                els.currTimeEl.textContent = formatTime(els.audio.currentTime);
            };
            els.audio.onloadedmetadata = () => {
                els.durationEl.textContent = formatTime(els.audio.duration);
            };

            // Seeking
            els.seekContainer.onclick = (e) => {
                const rect = els.seekContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                els.audio.currentTime = pos * els.audio.duration;
            };

            // Restore audio src if it was lost but we have track state
            const audioHasNoSrc =
                !els.audio.src ||
                els.audio.src === "" ||
                els.audio.src === window.location.href;
            if (audioHasNoSrc && state.track && state.track.url) {
                els.audio.src = state.track.url;
                // If was playing, resume
                if (state.isPlaying) {
                    els.audio.currentTime = state.currentTime || 0;
                    els.audio.play().catch(() => {});
                }
            }

            // --- Global playTrack Function ---
            window.playTrack = async function (track) {
                if (!track || !track.type || !track.url) {
                    console.error("Invalid track object", track);
                    return;
                }

                const provider = providers[track.type];
                if (!provider) {
                    console.error("Unknown provider:", track.type);
                    return;
                }

                // Immediate UI feedback
                state.track = {
                    title: track.title || "Loading...",
                    artist: track.artist || provider.name,
                    artwork: track.artwork,
                    url: track.url,
                    type: track.type,
                };
                state.currentTime = 0;
                syncUIWithState();

                try {
                    const meta = await provider.resolve(track);

                    // Update state with resolved metadata
                    state.track = { ...meta, type: track.type };
                    syncUIWithState();

                    // Play
                    els.audio.src = meta.url;
                    els.audio
                        .play()
                        .catch((e) => console.error("Playback failed:", e));
                } catch (error) {
                    console.error("Provider error:", error);
                    state.track = {
                        title: track.title || "Error",
                        artist: "Playback Failed",
                        artwork: track.artwork,
                    };
                    syncUIWithState();
                }
            };

            // --- Legacy toggleMusic ---
            window.toggleMusic = function (playerType, url) {
                const clickedImg = window.event?.target;
                let title = clickedImg?.getAttribute("alt") || "";
                let artwork = clickedImg?.getAttribute("src") || "";
                let type = url.includes("music.apple.com") ? "apple" : "local";

                window.playTrack({ type, url, title, artwork });
            };

            // Always sync UI
            syncUIWithState();
        }

        // Listen for page loads
        document.addEventListener("astro:page-load", initPlayer);
    })();
</script>

<style>
    #player-play-btn span {
        font-family: system-ui, sans-serif;
        font-size: 14px;
        font-weight: bold;
    }
    #player-seek-container:hover #player-progress-bar {
        background: var(--text-muted);
    }
</style>
