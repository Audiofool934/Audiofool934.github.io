---
// AudioPlayer Component - Persistent Now Playing bar with Apple Music iframe
// This component should be included in pages that need the player

interface Props {
    initialTrackUrl?: string;
    initialTrackTitle?: string;
}

const { initialTrackUrl = "", initialTrackTitle = "Select a track..." } =
    Astro.props;
---

<div
    id="audio-player-bar"
    class="flex flex-col gap-4 w-full bg-[var(--bg-body)] z-[100] transition-all duration-300 mt-auto"
    transition:persist
>
    <!-- Hidden Audio Element -->
    <audio id="main-audio-element" preload="auto"></audio>

    <!-- Header -->
    <div class="flex items-center justify-between">
        <span
            class="text-[10px] font-mono uppercase tracking-widest text-[var(--text-muted)]"
            >Now Playing</span
        >
        <div class="flex items-center gap-2">
            <div class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse">
            </div>
            <span class="text-[10px] font-mono text-[var(--text-muted)]"
                >Online</span
            >
        </div>
    </div>

    <!-- Art -->
    <div
        id="player-art"
        class="w-full aspect-square bg-[var(--bg-body)] border border-[var(--border-main)] relative overflow-hidden group"
    >
        <img
            id="player-art-img"
            src=""
            class="absolute inset-0 w-full h-full object-cover opacity-0 transition-opacity duration-500"
        />
        <div
            id="player-art-placeholder"
            class="absolute inset-0 flex items-center justify-center font-mono text-2xl text-[var(--text-muted)]"
        >
            üìª
        </div>

        <!-- Hover Overlay for Play Toggle -->
        <div
            class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center cursor-pointer"
            onclick="document.getElementById('player-play-btn').click()"
        >
            <span class="text-white text-3xl opacity-80 hover:opacity-100"
                >‚èØ</span
            >
        </div>
    </div>

    <!-- Track Info -->
    <div class="flex flex-col min-w-0">
        <div
            id="player-track-name"
            class="text-sm font-bold truncate leading-tight"
        >
            Select a track...
        </div>
        <div
            id="player-artist-name"
            class="text-xs text-[var(--text-muted)] truncate mt-1"
        >
            AudioShow
        </div>
    </div>

    <!-- Controls & Progress -->
    <div class="flex flex-col gap-3 w-full">
        <!-- Progress Bar -->
        <div
            class="w-full h-1 bg-[var(--text-muted)]/30 relative group cursor-pointer"
            id="player-seek-container"
        >
            <div
                id="player-progress-bar"
                class="absolute top-0 left-0 h-full bg-[var(--text-main)] w-0"
            >
            </div>
            <!-- Hit Area -->
            <div
                class="absolute -top-2 -bottom-2 left-0 right-0 bg-transparent"
            >
            </div>
        </div>

        <!-- Time & Controls -->
        <div
            class="flex items-center justify-between text-[10px] font-mono text-[var(--text-muted)]"
        >
            <span id="player-current-time">0:00</span>
            <button
                id="player-play-btn"
                class="hover:text-[var(--text-main)] transition-colors disabled:opacity-30 p-1"
                disabled
            >
                <span id="play-icon" class="text-xl">‚ñ∂</span>
            </button>
            <span id="player-duration">0:00</span>
        </div>
    </div>
</div>

<script is:inline>
    // Audio Player State Management
    (function () {
        // Initialize only once even with View Transitions
        function initPlayer() {
            const playerBar = document.getElementById("audio-player-bar");
            const audio = document.getElementById("main-audio-element");
            const playBtn = document.getElementById("player-play-btn");
            const playIcon = document.getElementById("play-icon");
            const seekContainer = document.getElementById(
                "player-seek-container",
            );
            const progressBar = document.getElementById("player-progress-bar");
            const currTimeEl = document.getElementById("player-current-time");
            const durationEl = document.getElementById("player-duration");
            const trackNameEl = document.getElementById("player-track-name");
            const artistNameEl = document.getElementById("player-artist-name");
            const artImg = document.getElementById("player-art-img");
            const artPlaceholder = document.getElementById(
                "player-art-placeholder",
            );

            if (!audio || !playBtn) return;

            function formatTime(seconds) {
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, "0")}`;
            }

            // Play/Pause Toggle
            playBtn.onclick = () => {
                if (audio.paused) {
                    audio.play();
                } else {
                    audio.pause();
                }
            };

            audio.onplay = () => {
                playIcon.textContent = "II";
            };

            audio.onpause = () => {
                playIcon.textContent = "‚ñ∂";
            };

            // Progress Update
            audio.ontimeupdate = () => {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressBar.style.width = `${percent}%`;
                currTimeEl.textContent = formatTime(audio.currentTime);
            };

            audio.onloadedmetadata = () => {
                durationEl.textContent = formatTime(audio.duration);
                playBtn.disabled = false;
            };

            // Seeking
            seekContainer.onclick = (e) => {
                const rect = seekContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                audio.currentTime = pos * audio.duration;
            };

            // Fetch and Play Track from Apple Music URL
            window.playTrack = async function (musicUrl, manualTitle) {
                console.log("Custom Player: Fetching preview for", musicUrl);

                // Show loading state
                trackNameEl.textContent = manualTitle || "Loading...";
                artistNameEl.textContent = "Fetching track data...";
                playBtn.disabled = true;

                // Extract Track ID
                const match = musicUrl.match(/[?&]i=(\d+)/);
                const trackId = match ? match[1] : null;

                if (!trackId) {
                    console.error("Invalid Apple Music URL format");
                    trackNameEl.textContent = "Invalid URL";
                    return;
                }

                try {
                    // Fetch metadata from iTunes Search API (no token needed)
                    // Added country=cn to match the user's links
                    const response = await fetch(
                        `https://itunes.apple.com/lookup?id=${trackId}&country=cn`,
                    );
                    const data = await response.json();

                    if (data.resultCount > 0) {
                        const track = data.results[0];

                        // Update UI
                        trackNameEl.textContent = track.trackName;
                        artistNameEl.textContent = track.artistName;
                        if (track.artworkUrl100) {
                            artImg.src = track.artworkUrl100.replace(
                                "100x100",
                                "300x300",
                            );
                            artImg.style.opacity = "1";
                            artPlaceholder.style.opacity = "0";
                        }

                        // Load and Play Audio
                        audio.src = track.previewUrl;
                        audio.play();
                    } else {
                        trackNameEl.textContent =
                            manualTitle || "Track Not Found";
                        artistNameEl.textContent = "Unable to fetch metadata";
                    }
                } catch (error) {
                    console.error("iTunes API error:", error);
                    trackNameEl.textContent = manualTitle || "Error Loading";
                }
            };

            // Hijack legacy toggleMusic
            window.toggleMusic = function (iframeId, musicUrl) {
                const event = window.event;
                const clickedImg = event?.target;
                let manualTitle = "";
                if (clickedImg && clickedImg.tagName === "IMG") {
                    manualTitle = clickedImg.getAttribute("alt") || "";
                }
                window.playTrack(musicUrl, manualTitle);
            };
        }

        // Initialize on load and after every navigation
        document.addEventListener("astro:page-load", initPlayer);
    })();
</script>

<style>
    #player-play-btn span {
        font-family: system-ui, sans-serif;
        font-size: 14px;
        font-weight: bold;
    }
    #player-seek-container:hover #player-progress-bar {
        background: var(--text-muted);
    }
</style>
